# LanderPi ROS2 Stack
# Persists across reboots with restart: unless-stopped

services:
  ros2-stack:
    image: landerpi-ros2:latest
    container_name: landerpi-ros2
    restart: unless-stopped
    network_mode: host
    privileged: true

    devices:
      - /dev/ttyAMA0:/dev/ttyAMA0    # Motor controller
      - /dev/ttyUSB0:/dev/ttyUSB0    # Lidar (primary)
      - /dev/ttyUSB1:/dev/ttyUSB1    # Lidar (fallback)

    volumes:
      # Custom nodes (read-only)
      - ../ros2_nodes/cmd_vel_bridge:/ros2_ws/src/cmd_vel_bridge:ro
      - ../ros2_nodes/arm_controller:/ros2_ws/src/arm_controller:ro
      - ../ros2_nodes/lidar_driver:/ros2_ws/src/lidar_driver:ro
      - ../ros2_nodes/battery_monitor:/ros2_ws/src/battery_monitor:ro
      - ../ros2_nodes/depth_stats:/ros2_ws/src/depth_stats:ro
      - ../ros2_nodes/yolo_detector:/ros2_ws/src/yolo_detector:ro
      - ../ros2_nodes/obstacle_fusion:/ros2_ws/src/obstacle_fusion:ro
      # Vendor drivers (read-only) - never modified
      - ../drivers/ros_robot_controller-ros2/src/ros_robot_controller:/ros2_ws/src/ros_robot_controller:ro
      - ../drivers/ros_robot_controller-ros2/src/ros_robot_controller_msgs:/ros2_ws/src/ros_robot_controller_msgs:ro
      # Camera driver workspace (built on robot, optional)
      - ~/deptrum_ws:/deptrum_ws:ro
      # Config (read-only)
      - ../config:/ros2_ws/config:ro
      # Build artifacts (persistent)
      - ros2_build:/ros2_ws/build
      - ros2_install:/ros2_ws/install
      - ros2_log:/ros2_ws/log

    environment:
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp

    command: >
      bash -c "
        set -e
        source /opt/ros/humble/setup.bash
        cd /ros2_ws

        echo '=== Installing pyserial for lidar driver ==='
        pip3 install -q pyserial 2>/dev/null || true

        echo '=== Building ROS2 packages ==='
        colcon build --symlink-install --packages-select ros_robot_controller_msgs ros_robot_controller cmd_vel_bridge arm_controller lidar_driver battery_monitor depth_stats yolo_detector obstacle_fusion

        source install/setup.bash

        # Source camera driver if available
        if [ -f /deptrum_ws/install/local_setup.bash ]; then
          echo '=== Sourcing camera driver ==='
          source /deptrum_ws/install/local_setup.bash
        fi

        echo '=== Starting LanderPi ROS2 stack ==='
        ros2 launch cmd_vel_bridge landerpi.launch.py
      "

volumes:
  ros2_build:
  ros2_install:
  ros2_log:
